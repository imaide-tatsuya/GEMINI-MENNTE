<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>車両メンテナンス作業依頼一覧</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 15px; background-color: #f4f4f4; color: #333; }
        h1 { text-align: center; color: #333; font-size: 1.5em; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9em; }
        th { background-color: #e9e9e9; font-weight: bold; }
        .request-id a { color: #007bff; text-decoration: none; font-weight: bold; }
        .request-id a:hover { text-decoration: underline; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        #loading-message { text-align: center; padding: 20px; font-style: italic; }
        #error-message { text-align: center; padding: 20px; color: red; font-weight: bold; }

        /* スマホ表示を考慮したスタイル */
        @media screen and (max-width: 768px) {
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr { border: 1px solid #ccc; margin-bottom: 10px;}
            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 45%; /* ラベル表示領域 */
                padding-top: 8px;
                padding-bottom: 8px;
                text-align: right; /* 値を右寄せ */
                min-height: 24px; /* 高さを確保 */
            }
            td:before {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                left: 8px;
                width: 40%; /* ラベルの幅 */
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
            }
            td:nth-of-type(1):before { content: "依頼ID"; }
            td:nth-of-type(2):before { content: "依頼日"; }
            td:nth-of-type(3):before { content: "納期"; }
            td:nth-of-type(4):before { content: "初期メンテ"; }
            td:nth-of-type(5):before { content: "写真撮影"; }
            td:nth-of-type(6):before { content: "社内管理No"; }
            td:nth-of-type(7):before { content: "車両移動先"; }
            td:nth-of-type(8):before { content: "その他"; }
            .request-id { font-weight: bold; }
        }
    </style>
</head>
<body>
    <h1>車両メンテナンス作業依頼一覧</h1>

    <div id="loading-message">データを読み込み中です...</div>
    <div id="error-message" style="display:none;"></div>

    <table>
        <thead>
            <tr>
                <th>依頼ID(車台番号)</th>
                <th>依頼日</th>
                <th>納期</th>
                <th>初期メンテ</th>
                <th>写真撮影</th>
                <th>社内管理No貼付</th>
                <th>車両移動先</th>
                <th>その他</th>
            </tr>
        </thead>
        <tbody id="request-list">
            </tbody>
    </table>

    <script>
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ 必ずここに、Google Apps Scriptをデプロイした際に取得した「ウェブアプリのURL」を設定してください ★
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        const spreadSheetUrl = 'https://script.google.com/macros/s/AKfycbxcwweBrhTwCu0SzRl_6gFMnviXP_O_8RAzZA9jPqHpWcruTLyWA0dqNuyxgstme1e0aw/exec'; // 例: 'https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXX/exec'

        const requestListBody = document.getElementById('request-list');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');

        async function fetchRequests() {
            if (spreadSheetUrl === 'https://script.google.com/macros/s/AKfycbxcwweBrhTwCu0SzRl_6gFMnviXP_O_8RAzZA9jPqHpWcruTLyWA0dqNuyxgstme1e0aw/exec' || spreadSheetUrl === 'https://script.google.com/macros/s/AKfycbxcwweBrhTwCu0SzRl_6gFMnviXP_O_8RAzZA9jPqHpWcruTLyWA0dqNuyxgstme1e0aw/exec') {
                loadingMessage.style.display = 'none';
                errorMessage.textContent = 'エラー: Google Apps ScriptのウェブアプリURLが設定されていません。scriptタグ内のspreadSheetUrlを確認してください。';
                errorMessage.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(spreadSheetUrl);
                if (!response.ok) {
                    // response.status や response.statusText で詳細なエラー情報を取得可能
                    let errorText = `データの読み込みに失敗しました。ステータス: ${response.status}`;
                    try {
                        const errorData = await response.json(); // GASからエラー詳細がJSONで返ってくる場合
                        if (errorData && errorData.error) {
                           errorText += ` - ${errorData.error}`;
                           if(errorData.details) errorText += ` (詳細: ${errorData.details})`;
                        }
                    } catch (e) {
                        // JSONパース失敗
                    }
                    throw new Error(errorText);
                }

                const data = await response.json(); // GASからの応答はJSON形式のはず
                
                loadingMessage.style.display = 'none'; // 読み込みメッセージを非表示
                requestListBody.innerHTML = ''; // 既存の行をクリア（念のため）

                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        // JSONのキー名 (item.id, item.requestDateなど) は、GASのdoGet関数で返しているものと一致させる
                        tr.innerHTML = `
                            <td class="request-id"><a href="check.html?jobId=${item.id}&dueDate=${item.dueDate || ''}">${item.id || 'N/A'}</a></td>
                            <td>${item.requestDate || ''}</td>
                            <td>${item.dueDate || ''}</td>
                            <td>${item.initialMaintenance || ''}</td>
                            <td>${item.photoShooting || ''}</td>
                            <td>${item.internalMgmtNo || ''}</td>
                            <td>${item.vehicleLocation || ''}</td>
                            <td>${item.other || ''}</td>
                        `;
                        requestListBody.appendChild(tr);
                    });
                } else if (Array.isArray(data) && data.length === 0) {
                    errorMessage.textContent = '表示する作業依頼はありません。';
                    errorMessage.style.display = 'block';
                } else {
                    // データが配列でない、または予期しない形式の場合
                    console.error('Fetched data is not an array or is empty:', data);
                    errorMessage.textContent = '受信したデータの形式が正しくありません。GASの応答を確認してください。';
                    errorMessage.style.display = 'block';
                }

            } catch (error) {
                console.error('Error fetching requests:', error);
                loadingMessage.style.display = 'none';
                errorMessage.textContent = `エラー: ${error.message}`;
                errorMessage.style.display = 'block';
                requestListBody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">データの読み込みに失敗しました。詳細はコンソールを確認してください。</td></tr>`;
            }
        }

        // ページが読み込まれたらデータを取得して表示
        window.onload = fetchRequests;
    </script>
</body>
</html>
